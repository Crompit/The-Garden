import discord
from discord.ext import commands, tasks
import random
import asyncio
from flask import Flask
from threading import Thread

# ======= WEB SERVER FOR 24/7 =======
app = Flask('')

@app.route('/')
def home():
    return "âœ… Bot is running 24/7"

def run():
    app.run(host='0.0.0.0', port=8080)

def keep_alive():
    t = Thread(target=run)
    t.start()

# ======= DISCORD BOT SETUP =======
intents = discord.Intents.default()
intents.message_content = True
intents.members = True
intents.invites = True

bot = commands.Bot(command_prefix="!", intents=intents, help_command=None)

invite_cache = {}
user_balances = {}

@bot.event
async def on_ready():
    print(f"âœ… Logged in as {bot.user}")
    for guild in bot.guilds:
        invites = await guild.invites()
        invite_cache[guild.id] = invites

# âœ… INVITE TRACKER
@bot.event
async def on_member_join(member):
    await asyncio.sleep(1)  # Give Discord time to update invites
    guild = member.guild
    before = invite_cache.get(guild.id, [])
    after = await guild.invites()
    invite_cache[guild.id] = after

    inviter = None
    for invite in after:
        for old_invite in before:
            if invite.code == old_invite.code and invite.uses > old_invite.uses:
                inviter = invite.inviter
                uses = invite.uses
                break

    channel = discord.utils.get(guild.text_channels, name="general")
    if channel:
        if inviter:
            await channel.send(f"ğŸ‰ {member.mention} joined using {inviter.mention}'s invite! They now have ({uses}) invites.")
        else:
            await channel.send(f"ğŸ‰ Welcome {member.mention} to the server!")

# âœ… CONFESSION COMMAND
@bot.command()
async def confess(ctx, *, message):
    confession_channel = discord.utils.get(ctx.guild.text_channels, name="confessions")
    if confession_channel:
        await confession_channel.send(f"ğŸ’Œ **Anonymous Confession:** {message}")
        await ctx.send("âœ… Your confession was sent anonymously.")
    else:
        await ctx.send("âŒ No #confessions channel found. Please create one.")

# âœ… ECONOMY SYSTEM
@bot.command()
async def daily(ctx):
    user = ctx.author
    amount = random.randint(50, 150)
    user_balances[user.id] = user_balances.get(user.id, 0) + amount
    await ctx.send(f"ğŸ’° {user.mention}, you claimed your daily reward of {amount} coins!")

@bot.command()
async def balance(ctx):
    user = ctx.author
    coins = user_balances.get(user.id, 0)
    await ctx.send(f"ğŸ’¸ {user.mention}, you have {coins} coins.")

# âœ… REMINDER COMMAND
@bot.command()
async def remind(ctx, time: str, *, task: str):
    seconds = 0
    if time.endswith("s"):
        seconds = int(time[:-1])
    elif time.endswith("m"):
        seconds = int(time[:-1]) * 60
    elif time.endswith("h"):
        seconds = int(time[:-1]) * 3600
    else:
        await ctx.send("âŒ Invalid time format! Use s, m, or h (e.g. 10s, 5m, 1h).")
        return

    await ctx.send(f"â° Okay {ctx.author.mention}, Iâ€™ll remind you in {time} to: {task}")
    await asyncio.sleep(seconds)
    await ctx.author.send(f"ğŸ”” Reminder: {task}")

# âœ… BASIC COMMANDS
@bot.command()
async def ping(ctx):
    await ctx.send("ğŸ“ Pong!")

@bot.command()
async def say(ctx, *, text):
    await ctx.send(text)

@bot.command()
async def meme(ctx):
    memes = [
        "https://i.imgur.com/w3duR07.png",
        "https://i.imgur.com/a2j1d9V.jpeg",
        "https://i.imgur.com/z5eKj8m.jpeg"
    ]
    await ctx.send(random.choice(memes))

# âœ… HELP COMMAND
@bot.command()
async def help(ctx):
    embed = discord.Embed(
        title="ğŸ“– Bot Commands",
        description="Hereâ€™s what I can do:",
        color=discord.Color.blurple()
    )
    embed.add_field(name="ğŸ“ !ping", value="Test if bot is online.", inline=False)
    embed.add_field(name="ğŸ—£ !say <message>", value="Make the bot say something.", inline=False)
    embed.add_field(name="ğŸ–¼ !meme", value="Get a random meme.", inline=False)
    embed.add_field(name="ğŸ‘¢ !kick @user", value="Kick a user (requires permissions).", inline=False)
    embed.add_field(name="ğŸ”¨ !ban @user", value="Ban a user (requires permissions).", inline=False)
    embed.add_field(name="ğŸ§¹ !purge <number>", value="Delete messages in bulk.", inline=False)
    embed.add_field(name="ğŸ !giveaway <seconds> <prize>", value="Start a quick giveaway.", inline=False)
    embed.add_field(name="ğŸ’Œ !confess <message>", value="Send an anonymous confession to #confessions.", inline=False)
    embed.add_field(name="ğŸ’° !daily", value="Get your daily coins reward.", inline=False)
    embed.add_field(name="ğŸ’¸ !balance", value="Check your coin balance.", inline=False)
    embed.add_field(name="â° !remind <time> <task>", value="Set a reminder (e.g. !remind 10m drink water).", inline=False)
    embed.set_footer(text="Bot made by ImpactX ğŸ”¥")
    await ctx.send(embed=embed)

# ====== KEEP ALIVE + RUN BOT ======
keep_alive()
bot.run("")
